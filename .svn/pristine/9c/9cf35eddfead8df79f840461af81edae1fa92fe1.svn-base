<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE8" content="ie=edge" content="text/html;charset=UTF-8"/>
	<title>呼叫中心系统</title>
	<link rel="stylesheet" type="text/css" href="themes/default/easyui.css">
	<link rel="stylesheet" type="text/css" href="themes/icon.css">
	<link rel="stylesheet" type="text/css" href="demo.css">

	<style type="text/css">
		.myStyle{
			text-decoration:none;
			color:#1fffff;
			font-size: 12px;
		}
		
		.myStyle:visited
		{
			color:#B2C0D0;
		}
		
		.myStyle:hover
		{
			color:#00ff00;
		}
		
	</style>

	<script type="text/javascript" src="jquery.min.js"></script>
	<script type="text/javascript" src="jquery.easyui.min.js"></script>
	<script type="text/javascript" src="locale/easyui-lang-zh_CN.js"></script>
	<script type="text/javascript">
		var currTelephone = null;
		function addTab(title, url){
			if ($('#layout_center_tabs').tabs('exists', title)){
				$('#layout_center_tabs').tabs('select', title);
			} else {
				var content = '<iframe scrolling="auto" frameborder="0"  src="'+url+'" style="width:99.5%;padding-left:3px;padding-top:0px;height:99%;margin:0 auto;"></iframe>';
				$('#layout_center_tabs').tabs('add',{
					title:title,
					content:content,
					closable:true
				});
			}
		}
	</script>
	
	<script type="text/javascript">
	var currFlg = 0;
	//用于控制 tab 的右击事件
	$(function(){

		$('#layout_center_tabsMenu').menu({
			onClick : function(item) {
				var curTabTitle = $(this).data('tabTitle');
				var type = $(item.target).attr('type');
				
	
				if (type === 'refresh') {

					var t = $('#layout_center_tabs').tabs('getTab', curTabTitle);
					var iframe = $(t.panel('options').content);
					var url=iframe.attr("src");
					var currTab = $('#layout_center_tabs').tabs('getSelected');
					var content = '<iframe scrolling="auto" frameborder="0"  src="'+url+'" style="width:99.5%;padding-left:3px;padding-top:0px;height:99%;margin:0 auto;"></iframe>';

					$('#layout_center_tabs').tabs('update',{
						tab:currTab,
						options:{
							content:content
						}
					});
						
					//layout_center_refreshTab(curTabTitle);
					return;
				}
	
				if (type === 'close') {
					var t = $('#layout_center_tabs').tabs('getTab', curTabTitle);
					if (t.panel('options').closable) {
						$('#layout_center_tabs').tabs('close', curTabTitle);
					}
					return;
				}
	
				var allTabs = $('#layout_center_tabs').tabs('tabs');
				var closeTabsTitle = [];
	
				$.each(allTabs, function() {
					var opt = $(this).panel('options');
					if (opt.closable && opt.title != curTabTitle && type === 'closeOther') {
						closeTabsTitle.push(opt.title);
					} else if (opt.closable && type === 'closeAll') {
						closeTabsTitle.push(opt.title);
					}
				});
	
				for ( var i = 0; i < closeTabsTitle.length; i++) {
					$('#layout_center_tabs').tabs('close', closeTabsTitle[i]);
				}
			}
		});
		
		$('#layout_center_tabs').tabs({
			fit : true,
			border : false,
			onContextMenu : function(e, title) {
				e.preventDefault();
				$('#layout_center_tabsMenu').menu('show', {
					left : e.pageX,
					top : e.pageY
				}).data('tabTitle', title);
			},
			tools : [ {
				iconCls : 'icon-reload',
				handler : function() {
					var href = $('#layout_center_tabs').tabs('getSelected').panel('options').href;
					if (href) {/*说明tab是以href方式引入的目标页面*/
						var index = $('#layout_center_tabs').tabs('getTabIndex', $('#layout_center_tabs').tabs('getSelected'));
						$('#layout_center_tabs').tabs('getTab', index).panel('refresh');
					} 
				}
			}]
		});

		$.ajax({
			type:'POST',
			dataType:"json",
			url:'module/menu?currOperId=${currOperId}',
			success:function(data) {
				var ndata = data[0].children;

				$.each(ndata,function(idx,item){
					var con = "";
					$.each(item.children,function(i,n){
						con += '<div style="padding:2px;"><a href="#" class="easyui-linkbutton" data-options="plain:true,iconCls:\'icon-folderopened\'" onclick="addTab(\'' + n.text + '\',\'' + n.uri + '\')">' + n.text + '</a></div>';
					});
					$("#menu-accordion").accordion('add',{
						title:item.text,
						content:con,
						selected:item.state
					});
					
				});
						
			}
		});

		//关联页面关闭事件(IE浏览器下可正常工作)
		//$(window).unload(function() {
		//	logout();
		//});

		$("#clientTouchRecordDg").datagrid({
			pageSize:10,
			pagination:true,      
			fit:true,
			singleSelect:true,
			rowrap:true,
			striped: true,
			rownumbers: true,
			pageList:[10,15,20]
		});

		$("#clientPg").propertygrid({
			//url:'taskExecute/propertygrid',
			type:'post',
			showGroup:false,
			showHeader:false,
			onLoadSuccess:function() {

				
			}
		});

		//用于定时扫描当前座席的来电弹屏
		setInterval(function(){
			//$("#currentTime").text(new Date().toLocaleString());
			$.ajax({
				type:'POST',
				dataType:"json",
				url:'scan',
				success:function(data) {
					//alert(data);							
				}
			});
			
		},200000);

		//修改密码对话框
		$("#changepasswordpanel").dialog({
			onClose:function() {
				$("#changepasswordform").form("clear");
			}
		});

		$("#dialpanel").dialog({
			onClose:function() {
				$("#touchrecordresultform").form("clear");
				cancelCheckResult();
			}
		});
		
	});

	function cancelCheckResult() {
		$("#touchresult1").css("display","none");
		$("#touchresult2").css("display","none");
		//$("#touchresult1").css("display","none");
	}
	
	function checkresult(flg){
		currFlg = flg;
		cancelCheckResult();
		if(flg==1) {
			$("#touchresult1").css("display","");
		}else if(flg==2){
			$("#touchresult2").css("display","");
		}	
	}

	function logout() {
		$("#logoutForm").submit();
	}

	function modifyPassword() {
		//alert("aa");
		$("#changepasswordpanel").dialog('open');
	}
	
	function changePassword_cancel() {
		$("#changepasswordpanel").dialog("close");
	}

	function changePassword_save() {
		
		$("#changepasswordform").form('submit',{
			url:"operator/changePassword",
			onSubmit:function(){
				var vld = $(this).form('validate');

				if(vld==false) {
					return vld;
				}
				
				var pass1 = $("#NEW_PASSWORD").val();
				var pass2 = $("#RE_NEW_PASSWORD").val();
				if(pass1!=pass2){
					$.messager.alert("提示","修改失败，新密码及确认新密码不相同!","error");
					return false;
				}
				return vld;
			},
			success:function(data) {
				var result = JSON.parse(data);    //解析Json 数据
				
				var statusCode = result.statusCode; //返回的结果类型
				var message = result.message;       //返回执行的信息
				
				showMessage(message,statusCode);
				if(statusCode == 'success') {         //保存成功时，才关闭窗口及重新刷新数据
					$("#changepasswordpanel").dialog("close");
				}
								
			}
		});
	}

	function touchTypeFormatter(value,data,index) {
		if(value=='1') {
			return "呼出";
		}else {
			return "呼入";
		}	
	}
	
	function myformatter(value,data,index) {
		if(data.name=='客户性别') {
			return value=="1"?"男":"女";
		}else if(data.name=='客户级别'){
			var index2 = 0;

			if(value=="1") {
				index2 = 0;
			}else if(value=="2") {
				index2 = 1;
			}else if(value=="3") {
				index2 = 2;
			}else if(value=="4") {
				index2 = 3;
			}else if(value=="5") {
				index2 = 4;
			}else if(value=="6") {
				index2 = 5;
			}else if(value=="7") {
				index2 = 6;
			}else if(value=="8") {
				index2 = 7;
			}else if(value=="9") {
				index2 = 8;
			}else if(value=="10") {
				index2 = 9;
			}
			if(data.editor.options.data[index2].text==null) {
				return ""; 
			}else{
				return data.editor.options.data[index2].text;
			}
		}else {
			return value;
		}
	}

	//客户资料显示及修改的 propertyGrid的定义
	var mycolumns=[[
			{field:'name',title:'name',width:78,sortable:true,align:'center'},
   			{field:'value',title:'value',width:172,formatter:myformatter}   
	    ]];
	function showdialpanel(telephone,telId,taskId) {
		currTelephone = telephone;
		currFlg = 0;
		$("#dialpanel").dialog('open');

		//设置号码id及任务id
		$("#telId").val(telId);
		$("#taskId").val(taskId);
		
		//列表客户信息
		$("#clientPg").propertygrid({
			url:'taskExecute/propertygrid?telephone=' + telephone + '&telId=' + telId,
			columns:mycolumns
		});
		//列表通话记录
		$("#clientTouchRecordDg").datagrid({
			url:'taskExecute/touchRecordDatagrid?telephone=' + currTelephone
		});
		//将呼叫失败的原因的 radio由服务端返回
		$.ajax({
			url:'getRadio?groupCode=TOUCH_FAILURE_REASON',
			method:'POST',
			dataType:'json',
			success:function(rs) {
				var statusCode = rs.statusCode; //返回的结果类型
				var message = rs.message;       //返回执行的信息
				//window.parent.showMessage(message,statusCode);
				if(statusCode == 'success') {         //返回的数据不为空时，才进行勾选当前操作员的角色
					$("#radioInfo").html(message);						
				}
			}
		});
	}

	//用于显示各种操作结果信息，如添加、修改、删除等信息
	function showMessage(message,status) {
		if(status=="success") {
			$.messager.show({
				title:'提示',
				msg:message,
				showType:'slide',
				style: {
					right:'',
					left:document.documentElement.offsetWidth/2-125,
					top:-5,
					bottom:''
				},
				timeout:2500
			});
		}else {
			$.messager.alert("提示",message,"error");
		}	
	}

	function saveTouchRecord() {
		//获取本次通话资料登记
		if(currFlg==0) {
			alert("无法提交：请选择本次接触结果后，再提交!");
			return;
		}

		
		var urlInfo = "taskExecute/add?flg=" + currFlg + "&telId=" + $("#telId").val() + "&taskId=" + $("#taskId").val();
		
		if(currFlg == 1) { 			//如果currFlg==1，即是接触失败
			var touchFailureReason = $("input[name='TOUCH_FAILURE_REASON']:checked").val();    //接触失败的原因
			if(typeof(touchFailureReason)=="undefined") {   //如果未选择接触失败原因
				alert("无法提交：请选择接触失败原因!");
				return;
			}
			var recallTime = $("#recallTime").datetimebox("getValue");              	  //再次外呼的时间
			var note = encodeURI(encodeURI($("#note").val()));                                       //备注

			
			
			urlInfo += "&touchFailureReason=" + touchFailureReason;
			urlInfo += "&recallTime=" + recallTime;
			urlInfo += "&note=" + note;
		}else if(currFlg == 2) {    //如果currFlg==2，接触成功
			alert("接触成功...");
		}else {                     //否则则是客户感兴趣
		}
		
		//获取客户信息
		var rows = $("#clientPg").propertygrid("getRows");
		
		for(var i=0; i<rows.length; i++){
			if(i==0) {         //客户编号
				urlInfo += "&clientNo=" + rows[i].value;
			}else if(i==1) {　  //客户号码
				urlInfo += "&clientTelephone=" + rows[i].value;
			}else if(i==2) {　  //备用号码
				urlInfo += "&clientTelephone2=" + rows[i].value;
			}else if(i==3) {　  //客户名称
				urlInfo += "&clientName=" + encodeURI(encodeURI(rows[i].value));
			}else if(i==4) {　  //客户级别
				urlInfo += "&clientLevel=" + rows[i].value;
			}else if(i==5) {　  //客户性别
				urlInfo += "&clientSex=" + rows[i].value;
			}else if(i==6) {　  //客户ＱＱ
				urlInfo += "&clientQq=" + rows[i].value;
			}else if(i==7) {　  //电子邮箱
				urlInfo += "&clientEmail=" + rows[i].value;
			}else if(i==8) {　  //公司信息
				urlInfo += "&clientCompany=" + encodeURI(encodeURI(rows[i].value));
			}else if(i==9) {  //地址信息
				urlInfo += "&clientAddress=" + encodeURI(encodeURI(rows[i].value));
			}else if(i==10) {　 //添加时间
				urlInfo += "&clientCreateTime=" + rows[i].value;
			}
			//s += rows[i].name + '(' + i + '):' + rows[i].value + ',\r\n';
		}

		/*$("#touchrecordresultform").form('submit',{
			url:urlInfo,
			type:'POST',
			success:function(data) {
				
			}			
		});*/
		
		$.ajax({
			url:urlInfo,
			type:'POST',
			dataType:'json',
			success:function(rs) {
				var statusCode = rs.statusCode; //返回的结果类型
				var message = rs.message;       //返回执行的信息
				window.parent.showMessage(message,statusCode);
				if(statusCode == 'success') {         //返回的数据不为空时，才进行勾选当前操作员的角色
				}
			}
		});
	}

</script>
</head>
<body class="easyui-layout">
	<!-- 顶部 Bannel start -->
	<div data-options="region:'north',border:false" style="overflow:hidden;height:50px;background:url('themes/icons/banner.png') repeat-x;">

		<img src="themes/icons/large_logo.png" />

		<div style="vertical-align: bottom;position:absolute;right:30px;bottom:3px;">
			<a href="#" onClick="modifyPassword()" class="myStyle" style="width:120px;text-decoration: none;color: 14AFFF;">修改密码</a>&nbsp;&nbsp;
			<a href="#" onClick="logout()" class="myStyle" style="width:120px;text-decoration: none;">退出系统</a>
		</div>
		<form id="logoutForm" action="logout" method="post">
		</form>

	</div>
	<!-- Bannel end -->
	
	<!-- 左则导航 start -->
	<div data-options="region:'west',split:true" title="主菜单" style="width:200px;padding1:1px;overflow:hidden;">
		<div id="menu-accordion" class="easyui-accordion" data-options="fit:true,border:false" style="background-color: #e0ecff">
			
		</div>
	</div>
	<!-- 左则导航 end -->
	
	<!-- 底部 start -->
	<div data-options="region:'south',border:false" style="height:25px;background:#dddddd;">
		<a href="#" class="easyui-linkbutton" data-options="fit:true" style="text-align: left;">
			<span style="font-weight: bold;">工号：${currOperId} 　　　　　操作员：${currOperName}     　　　　　 座席号：${currCallNumber}  </span>
			<div style="display: inline" id="currentTime"></div>
		</a>
	</div> 
	<!-- 底部 end -->
	
	<!-- 显示区 start -->
	<div data-options="region:'center'" style="overflow:hidden;">
<!--		<div id="layout_center_tabs" style="text-align: center;" class="easyui-tabs" data-options="fit:true,border:false">-->
		<div id="layout_center_tabs" class="easyui-tabs" data-options="fit:true">
			<div title="我的工作台" style="padding:20px;overflow:hidden;" data-options="fit:true"> 
			</div>
		</div>
	</div>
	<!-- 显示区 end -->

	<!-- tab 右击显示 -->
	<div id="layout_center_tabsMenu" style="width: 120px;display:none;">  
	    <div type="refresh">刷新</div>  
	    <div class="menu-sep"></div>  
	    <div type="close">关闭</div>  
	    <div type="closeOther">关闭其他</div>  
	    <div type="closeAll">关闭所有</div>  
	</div>	
	
	<!-- 将修改密码的窗口包含进来，在点击修改密码时，可以显示该窗口 -->
	<div id="changepasswordpanel" class="easyui-dialog" title="添加数据字典" data-options="width:300,height:200" modal="true" closed="true" buttons="#changePasswordBtn">
		<form id="changepasswordform">
				<!-- %@ include file="/_changepasswordform.jsp"% -->
				<table>
				<tr>
					<td>原密码</td>
					<td>
						<input name="operator.OLD_PASSWORD" id="OLD_PASSWORD" class="easyui-validatebox" type="text" required="true" missingMessage="原密码不能为空!"></input>
					</td>
				</tr>
				<tr>
					<td>新密码</td>
					<td>
						<input name="operator.NEW_PASSWORD" id="NEW_PASSWORD" type="password" class="easyui-validatebox" type="text" required="true" missingMessage="新密码不能为空!"></input>
					</td>
				</tr>
				<tr>
					<td>确认新密码</td>
					<td>
						<input name="operator.RE_NEW_PASSWORD" id="RE_NEW_PASSWORD" type="password" class="easyui-validatebox" type="text" required="true" missingMessage="确认新密码不能为空!"></input>
					</td>
				</tr>
			</table>
			
			<div id="changePasswordBtn">
				<a href="#" id="saveBtn" class="easyui-linkbutton" iconCls="icon-ok" onclick="changePassword_save()">保存</a>
				<a href="#" id="" class="easyui-linkbutton" iconCls="icon-cancel" onclick="changePassword_cancel()">取消</a>
			</div>
		</form>
	</div>

	<!-- 将外呼的窗口包含进来，在点击外呼时，可以显示该窗口并执行外呼 -->
	<%@ include file="/_dialpanel.jsp"%>	

</body>
</html>